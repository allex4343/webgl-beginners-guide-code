<html>

<head>
<title>WebGL Beginner's Guide - Chapter 9 - Car Show Room</title>
<meta http-equiv='content-type' content='text/html; charset=ISO-8859-1'>
<link href='css/styles.css'   type='text/css' rel='stylesheet'>
<link href='css/cars.css' type='text/css' rel='stylesheet' />
<link href='css/smoothness/jquery-ui-1.8.13.custom.css' type='text/css' rel='stylesheet' />
<!-- GUI Libraries //-->
<script type='text/javascript' src='js/gui/jquery-1.5.1.min.js'></script>
<script type='text/javascript' src='js/gui/jquery-ui-1.8.13.custom.min.js'></script> 

<!-- MATH Libraries //-->
<script type='text/javascript' src='js/math/glMatrix-0.9.5.min.js'></script>
<!-- WEBGL Libraries //-->
<script type='text/javascript' src='js/webgl/Globals.js'></script>
<script type='text/javascript' src='js/webgl/Utils.js'></script>
<script type='text/javascript' src='js/webgl/Program.js'></script>
<script type='text/javascript' src='js/webgl/Scene.js'></script>
<script type='text/javascript' src='js/webgl/Axis.js'></script>
<script type='text/javascript' src='js/webgl/Floor.js'></script>
<script type='text/javascript' src='js/webgl/Camera.js'></script>
<script type='text/javascript' src='js/webgl/CameraInteractor.js'></script>
<script type='text/javascript' src='js/webgl/SceneTransforms.js'></script>
<script type='text/javascript' src='js/webgl/Texture.js'></script>
<script type='text/javascript' src='js/webgl/Lights.js'></script>
<script type='text/javascript' src='js/webgl/WebGLApp.js'></script>
<script type='text/javascript' src='js/webgl/Picker.js'></script>

<script id="shader-vs" type="x-shader/x-vertex">

attribute vec3 aVertexPosition;
attribute vec3 aVertexNormal;
attribute vec4 aVertexColor;

uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat4 uNMatrix;

uniform vec3 uLightPosition;

varying vec3 vNormal;
varying vec3 vLightRay;
varying vec3 vEye;

void main(void) {

     vec4 c = aVertexColor;
     
     vec4 vertex = uMVMatrix * vec4(aVertexPosition, 1.0);
     
     vNormal = vec3(uNMatrix * vec4(aVertexNormal, 1.0));
     
     vec4 lightPosition =  vec4(uLightPosition,1.0);//uMVMatrix * vec4(uLightPosition, 1.0);
	 
     vLightRay = vertex.xyz - lightPosition.xyz;
     vEye = -vec3(vertex.xyz);
     
     gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
}	
</script>

<script id="shader-fs" type="x-shader/x-fragment">
#ifdef GL_ES
precision highp float;
#endif
//const int NUM_LIGHTS = 3;

uniform vec4 uLightAmbient;
uniform vec4 uLightDiffuse;

uniform vec4 uMaterialAmbient;
uniform vec4 uMaterialDiffuse;
uniform vec4 uMaterialSpecular;


uniform bool uWireframe;

varying vec3 vNormal;
varying vec3 vLightRay;
varying vec3 vEye;

void main(void) {
    if (uWireframe){
        gl_FragColor = uMaterialDiffuse;
    }
    else{

		vec4 COLOR = uLightAmbient * uMaterialAmbient;
        
        vec3 L = normalize(vLightRay);	
        vec3 N = normalize(vNormal);	
		float lambertTerm = dot(N, -L);
        if (lambertTerm > 0.2){
            COLOR += uLightDiffuse * uMaterialDiffuse *lambertTerm;
            
            vec3 E = normalize(vEye);
            vec3 R = reflect(L, N);
            float specular = pow( max(dot(R, E), 0.0), 100.0);
            
            COLOR += uMaterialSpecular * specular;
        }
        
        gl_FragColor =  COLOR;
        gl_FragColor.a = 1.0;
    }	
}
</script>

<script type="text/javascript">

var camera = null,
interactor = null,
transforms = null;

function configure(){
    gl.clearColor(0.3,0.3,0.3, 1.0);
    gl.clearDepth(100.0);
    
    gl.enable(gl.DEPTH_TEST);
    gl.depthFunc(gl.LEQUAL);
    
	gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);

    
    
    //Creates and sets up the camera location
    camera = new Camera(CAMERA_ORBITING_TYPE);
    camera.goHome([0,1,7]);
    camera.setFocus([0.0,0.0,0.0]);
	camera.setAzimuth(-45);
	camera.setElevation(-10);
    camera.hookRenderer = render;
    
    //Creates and sets up the mouse and keyboard interactor
    interactor = new CameraInteractor(camera, document.getElementById('the-canvas'));
    
    //Scene Transforms
    transforms = new SceneTransforms(camera);
   
    //init transforms
    transforms.init();
	
	
	

	//init Program
	var attributeList = ["aVertexPosition",
					"aVertexNormal",
					"aVertexColor"];

	var uniformList = [	"uPMatrix", 
					"uMVMatrix", 
					"uNMatrix",
                    "uLightPosition",
                    "uLightAmbient",
                    "uLightDiffuse",
                    "uWireframe",
                    "uMaterialAmbient",
                    "uMaterialDiffuse",
                    "uMaterialSpecular"
					];
				
	
	
	Program.load(attributeList, uniformList);	
    gl.uniform3fv(Program.uLightPosition, [0,15,0]);
    gl.uniform4fv(Program.uLightAmbient ,  [0.05,0.05,0.05,1.0]);
    gl.uniform4fv(Program.uLightDiffuse, [0.5,0.5,0.5,1.0]);
    
    gl.uniform4fv(Program.uMaterialAmbient ,  [1.0,1.0,1.0,1.0]);
    gl.uniform4fv(Program.uMaterialSpecular ,  [0.5,0.5,0.5,1.0]);
    

}

function load(){
    Floor.build(80,2);
    Scene.addObject(Floor);
    for(var i=1; i < 11; i++){
    Scene.loadObject('models/cars/bmw/pr'+i+'.json','bmw');
    }
  
}

function render(){
    gl.viewport(0, 0, c_width, c_height);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    
    
    transforms.updatePerspective();
    
    try{
        
      
        
        for (var i = 0; i < Scene.objects.length; i++){
            
            var object = Scene.objects[i];
			
			transforms.calculateModelView();           
            transforms.push();
            transforms.setMatrixUniforms();
            transforms.pop();
            
            gl.uniform4fv(Program.uMaterialDiffuse, object.diffuse);
   
            gl.enableVertexAttribArray(Program.aVertexPosition);
            gl.disableVertexAttribArray(Program.aVertexNormal);
            gl.disableVertexAttribArray(Program.aVertexColor);
            gl.uniform1i(Program.uWireframe, false);
            
            gl.bindBuffer(gl.ARRAY_BUFFER, object.vbo);
            gl.vertexAttribPointer(Program.aVertexPosition, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(Program.aVertexPosition);
            
			if(!object.wireframe){
				gl.bindBuffer(gl.ARRAY_BUFFER, object.nbo);
				gl.vertexAttribPointer(Program.aVertexNormal, 3, gl.FLOAT, false, 0, 0);
				gl.enableVertexAttribArray(Program.aVertexNormal);
            }
            else{
                gl.uniform1i(Program.uWireframe, true);
            }
			
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, object.ibo);
			
			if (object.wireframe){
                gl.drawElements(gl.LINES, object.indices.length, gl.UNSIGNED_SHORT,0);
            }
            else{
                gl.drawElements(gl.TRIANGLES, object.indices.length, gl.UNSIGNED_SHORT,0);
            }
			
            gl.bindBuffer(gl.ARRAY_BUFFER, null);
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);
            
        }
    }
    catch(err){
        alert(err);
        console.error(err.description);
    }
}


function resizeCanvas(){
    c_width = $('#content').width();
    c_height = $('#content').height();
    $('#the-canvas').attr('width',c_width);
    $('#the-canvas').attr('height',c_height);
}

$(window).resize(function(){resizeCanvas();});


var app = undefined;
function runShowRoom(){
    app = new WebGLApp("the-canvas");
    app.configureGLHook = configure;
    app.loadSceneHook   = load;
    app.drawSceneHook   = render;
    app.run(); 
}
</script>
</head>

<body onLoad='runShowRoom()'>
<div id="header">
    <h1>Show Room</h2>
</div>

<div id="nav">
    <b>Instructions</b>
</div>

<div id="content">
    <canvas id='the-canvas'></canvas>
</div>

<script type='text/javascript'>resizeCanvas();</script>
</body>
</html>